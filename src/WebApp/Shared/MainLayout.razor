@inherits LayoutComponentBase
@implements IDisposable
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ILocalizationService LocalizationService

<PageTitle>Getir - @GetLocalizedText("common.fast_delivery")</PageTitle>

<div class="page">
	<!-- Header -->
	<header class="getir-header">
		<div class="container">
			<div class="row align-items-center">
				<div class="col-6 col-md-3">
					<a href="/" class="getir-logo">
						<i class="bi bi-lightning-charge"></i>
						<span class="d-none d-sm-inline">Getir</span>
					</a>
				</div>
				<div class="col-6 col-md-3 d-md-none text-end">
					<!-- Mobile menu button -->
					<button class="btn btn-outline-primary btn-sm" @onclick="ToggleMobileMenu">
						<i class="bi bi-list"></i>
					</button>
				</div>
				<div class="col-12 col-md-6 d-none d-md-block">
					<div class="search-box">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="@GetLocalizedText("common.search_placeholder")" />
							<button class="btn btn-primary">
								<i class="bi bi-search"></i>
							</button>
						</div>
					</div>
				</div>
				<div class="col-12 col-md-3 d-none d-md-block">
					<nav class="getir-nav">
						<a href="/merchants" class="getir-nav-link">
							<i class="bi bi-shop"></i> <span class="d-none d-lg-inline">@GetLocalizedText("navigation.merchants")</span>
						</a>
						<a href="/cart" class="getir-nav-link">
							<i class="bi bi-cart"></i> <span class="d-none d-lg-inline">@GetLocalizedText("navigation.cart")</span>
						</a>
						
						<!-- Language Selector -->
						<LanguageSelector />
						
						<!-- PWA Install Button -->
						<button id="install-button" class="btn getir-nav-link d-none" style="display: none !important;">
							<i class="bi bi-download"></i> <span class="d-none d-lg-inline">@GetLocalizedText("pwa.install_app")</span>
						</button>
						@if (isAuthenticated)
						{
							<!-- User Dropdown Menu -->
							<div class="dropdown">
								<button class="btn getir-nav-link dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
									<i class="bi bi-person-circle"></i> <span class="d-none d-lg-inline">@(currentUser?.FullName ?? GetLocalizedText("common.my_account"))</span>
								</button>
								<ul class="dropdown-menu dropdown-menu-end">
									<li>
										<div class="dropdown-header">
											<div class="fw-bold">@(currentUser?.FirstName) @(currentUser?.LastName)</div>
											<small class="text-muted">@currentUser?.Email</small>
										</div>
									</li>
									<li><hr class="dropdown-divider"></li>
									<li>
										<a class="dropdown-item" href="/account">
											<i class="bi bi-person me-2"></i>@GetLocalizedText("navigation.profile_info")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/orders">
											<i class="bi bi-bag me-2"></i>@GetLocalizedText("navigation.my_orders")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/favorites">
											<i class="bi bi-heart me-2"></i>@GetLocalizedText("navigation.favorite_products")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/addresses">
											<i class="bi bi-geo-alt me-2"></i>@GetLocalizedText("navigation.my_addresses")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/notifications">
											<i class="bi bi-bell me-2"></i>@GetLocalizedText("navigation.notifications")
										</a>
									</li>
									<li><hr class="dropdown-divider"></li>
									<li>
										<a class="dropdown-item" href="/settings">
											<i class="bi bi-gear me-2"></i>@GetLocalizedText("common.settings")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/security">
											<i class="bi bi-shield-lock me-2"></i>@GetLocalizedText("navigation.security")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/permissions">
											<i class="bi bi-key me-2"></i>@GetLocalizedText("navigation.permissions")
										</a>
									</li>
									<li><hr class="dropdown-divider"></li>
									<li>
										<a class="dropdown-item" href="/help">
											<i class="bi bi-question-circle me-2"></i>@GetLocalizedText("navigation.help")
										</a>
									</li>
									<li>
										<a class="dropdown-item" href="/contact">
											<i class="bi bi-telephone me-2"></i>@GetLocalizedText("navigation.contact")
										</a>
									</li>
									<li><hr class="dropdown-divider"></li>
									<li>
										<a class="dropdown-item text-danger" @onclick="HandleLogout">
											<i class="bi bi-box-arrow-right me-2"></i>@GetLocalizedText("common.logout")
										</a>
									</li>
								</ul>
							</div>
						}
						else
						{
							<a href="/login" class="getir-nav-link">
								<i class="bi bi-box-arrow-in-right"></i> <span class="d-none d-lg-inline">@GetLocalizedText("common.login")</span>
							</a>
							<a href="/register" class="getir-nav-link">
								<i class="bi bi-person-plus"></i> <span class="d-none d-lg-inline">@GetLocalizedText("common.register")</span>
							</a>
						}

					</nav>
				</div>
			</div>

			<!-- Mobile Search -->
			<div class="row d-md-none mt-2 @(showMobileSearch ? "d-block" : "d-none")">
				<div class="col-12">
					<div class="search-box">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="@GetLocalizedText("common.search_placeholder")" />
							<button class="btn btn-primary">
								<i class="bi bi-search"></i>
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Mobile Menu -->
			<div class="row d-md-none mt-2 @(showMobileMenu ? "d-block" : "d-none")">
				<div class="col-12">
					<nav class="getir-nav-mobile">
						<div class="row">
							<div class="col-6 mb-2">
								<a href="/merchants" class="getir-nav-link d-block text-center p-2">
									<i class="bi bi-shop d-block"></i>
									<small>@GetLocalizedText("navigation.merchants")</small>
								</a>
							</div>
							<div class="col-6 mb-2">
								<a href="/cart" class="getir-nav-link d-block text-center p-2">
									<i class="bi bi-cart d-block"></i>
									<small>@GetLocalizedText("navigation.cart")</small>
								</a>
							</div>
							<div class="col-6 mb-2">
								<div class="getir-nav-link d-block text-center p-2">
									<LanguageSelector />
								</div>
							</div>
							<div class="col-6 mb-2">
								<button id="install-button-mobile" class="getir-nav-link d-block text-center p-2 w-100 border-0 bg-transparent" style="display: none !important;">
									<i class="bi bi-download d-block"></i>
									<small>@GetLocalizedText("pwa.install_app")</small>
								</button>
							</div>
							@if (isAuthenticated)
							{
								<div class="col-6 mb-2">
									<a href="/account" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-person d-block"></i>
										<small>@GetLocalizedText("common.profile")</small>
									</a>
								</div>
								<div class="col-6 mb-2">
									<a href="/orders" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-bag d-block"></i>
										<small>@GetLocalizedText("navigation.orders")</small>
									</a>
								</div>
								<div class="col-6 mb-2">
									<a href="/favorites" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-heart d-block"></i>
										<small>@GetLocalizedText("navigation.favorites")</small>
									</a>
								</div>
								<div class="col-6 mb-2">
									<a href="/addresses" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-geo-alt d-block"></i>
										<small>@GetLocalizedText("navigation.addresses")</small>
									</a>
								</div>
								<div class="col-6 mb-2">
									<a href="/settings" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-gear d-block"></i>
										<small>@GetLocalizedText("common.settings")</small>
									</a>
								</div>
								<div class="col-6 mb-2">
									<a href="/logout" class="getir-nav-link d-block text-center p-2" @onclick="HandleLogout">
										<i class="bi bi-box-arrow-right d-block"></i>
										<small>@GetLocalizedText("common.logout")</small>
									</a>
								</div>
							}
							else
							{
								<div class="col-6 mb-2">
									<a href="/login" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-box-arrow-in-right d-block"></i>
										<small>@GetLocalizedText("common.login")</small>
									</a>
								</div>
								<div class="col-6 mb-2">
									<a href="/register" class="getir-nav-link d-block text-center p-2">
										<i class="bi bi-person-plus d-block"></i>
										<small>@GetLocalizedText("common.register")</small>
									</a>
								</div>
							}
						</div>
					</nav>
				</div>
			</div>
		</div>
	</header>

	<!-- Main Content -->
	<main class="main-content">
		@Body
	</main>

	<!-- Footer -->
	<footer class="getir-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-3 footer-section">
					<h5>Getir</h5>
					<ul class="list-unstyled">
						<li><a href="/about">@GetLocalizedText("footer.about_us")</a></li>
						<li><a href="/careers">@GetLocalizedText("footer.careers")</a></li>
						<li><a href="/press">@GetLocalizedText("footer.press")</a></li>
						<li><a href="/contact">@GetLocalizedText("footer.contact")</a></li>
					</ul>
				</div>
				<div class="col-md-3 footer-section">
					<h5>@GetLocalizedText("footer.services")</h5>
					<ul class="list-unstyled">
						<li><a href="/merchants">@GetLocalizedText("footer.merchants")</a></li>
						<li><a href="/delivery">@GetLocalizedText("footer.delivery")</a></li>
						<li><a href="/support">@GetLocalizedText("footer.support")</a></li>
						<li><a href="/faq">@GetLocalizedText("footer.faq")</a></li>
					</ul>
				</div>
				<div class="col-md-3 footer-section">
					<h5>@GetLocalizedText("footer.legal")</h5>
					<ul class="list-unstyled">
						<li><a href="/privacy">@GetLocalizedText("footer.privacy_policy")</a></li>
						<li><a href="/terms">@GetLocalizedText("footer.terms_of_use")</a></li>
						<li><a href="/cookies">@GetLocalizedText("footer.cookie_policy")</a></li>
						<li><a href="/refund">@GetLocalizedText("footer.refund_policy")</a></li>
					</ul>
				</div>
				<div class="col-md-3 footer-section">
					<h5>@GetLocalizedText("footer.contact")</h5>
					<ul class="list-unstyled">
						<li><i class="bi bi-telephone"></i> +90 212 123 45 67</li>
						<li><i class="bi bi-envelope"></i> info@getir.com</li>
						<li><i class="bi bi-geo-alt"></i> @GetLocalizedText("footer.location")</li>
						<li>
							<div class="social-links mt-2">
								<a href="#" class="me-2"><i class="bi bi-facebook"></i></a>
								<a href="#" class="me-2"><i class="bi bi-twitter"></i></a>
								<a href="#" class="me-2"><i class="bi bi-instagram"></i></a>
								<a href="#"><i class="bi bi-linkedin"></i></a>
							</div>
						</li>
					</ul>
				</div>
			</div>
			<div class="footer-bottom">
				<p>&copy; 2024 Getir. @GetLocalizedText("footer.all_rights_reserved")</p>
			</div>
		</div>
</footer>

	<!-- Floating Live Chat Button -->
	@if (isAuthenticated)
	{
		<button class="btn btn-primary rounded-circle shadow position-fixed" style="right: 20px; bottom: 20px; width: 56px; height: 56px; z-index: 1050;" @onclick="ToggleChat">
			<i class="bi bi-chat-dots"></i>
		</button>
		<LiveChatComponent Show="showChat" ShowChanged="OnChatShowChanged" />
	}
</div>

@code {
	private bool isAuthenticated = false;
    private bool showMobileMenu = false;
    private bool showMobileSearch = false;
    private bool showChat = false;
	private AuthResponse? currentUser;

	protected override async Task OnInitializedAsync()
	{
		// Prerendering sırasında JavaScript interop çağrısı yapma
		// Authentication state'i OnAfterRenderAsync'da kontrol edilecek
		AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			// İlk render'dan sonra authentication state'i kontrol et
			isAuthenticated = await AuthService.IsAuthenticatedAsync();
			if (isAuthenticated)
			{
				currentUser = await AuthService.GetCurrentUserAsync();
			}
			await InvokeAsync(StateHasChanged);
		}
	}

	private async void OnAuthenticationStateChanged()
	{
		// Authentication state changed - no logging needed here as it's handled by AuthService
		isAuthenticated = await AuthService.IsAuthenticatedAsync();

		if (isAuthenticated)
		{
			currentUser = await AuthService.GetCurrentUserAsync();
		}
		else
		{
			currentUser = null;
		}
		await InvokeAsync(StateHasChanged);
	}

	public void Dispose()
	{
		AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
	}

	private async Task HandleLogout()
	{
		await AuthService.LogoutAsync();
		isAuthenticated = false;
		Navigation.NavigateTo("/");
	}

	private void ToggleMobileMenu()
	{
		showMobileMenu = !showMobileMenu;
		showMobileSearch = false; // Close search when opening menu
	}

	private void ToggleMobileSearch()
	{
		showMobileSearch = !showMobileSearch;
		showMobileMenu = false; // Close menu when opening search
	}

    private void ToggleChat()
    {
        showChat = !showChat;
    }

    private Task OnChatShowChanged(bool value)
    {
        showChat = value;
        return Task.CompletedTask;
    }

	private string GetLocalizedText(string key)
	{
		return LocalizationService.GetString(key);
	}
}
