@page "/security"
@using WebApp.Models
@inject UserService UserService
@inject AuthService AuthService
@inject ISecurityService SecurityService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject LocalizationService LocalizationService
@implements IDisposable

<PageTitle>@GetLocalizedText("security.title") - Getir</PageTitle>

@if (!isAuthenticated)
{
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-person-x display-1 text-warning mb-4"></i>
                        <h3>@GetLocalizedText("common.login")</h3>
                        <p class="text-muted mb-4">
                            @GetLocalizedText("security.login_required")
                        </p>
                        <a href="/login" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i>
                            @GetLocalizedText("common.login")
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@GetLocalizedText("common.loading")</span>
        </div>
        <p class="mt-3">@GetLocalizedText("security.loading_security_info")</p>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">@GetLocalizedText("common.home")</a></li>
                <li class="breadcrumb-item active" aria-current="page">@GetLocalizedText("security.title")</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <!-- Şifre Değiştirme -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-key"></i>
                            @GetLocalizedText("security.change_password")
                        </h4>
                    </div>
                    <div class="card-body">
                        <form @onsubmit="ChangePassword">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.current_password") *</label>
                                    <input type="password" class="form-control" @bind="changePasswordRequest.CurrentPassword" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.new_password") *</label>
                                    <input type="password" class="form-control" @bind="changePasswordRequest.NewPassword" required />
                                    <small class="text-muted">@GetLocalizedText("security.password_requirements")</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.confirm_password") *</label>
                                    <input type="password" class="form-control" @bind="changePasswordRequest.ConfirmPassword" required />
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" disabled="@isChangingPassword">
                                    @if (isChangingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check"></i>
                                    @GetLocalizedText("security.change_password")
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- E-posta Değiştirme -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-envelope"></i>
                            @GetLocalizedText("security.change_email")
                        </h4>
                    </div>
                    <div class="card-body">
                        <form @onsubmit="ChangeEmail">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.current_email")</label>
                                    <input type="email" class="form-control" value="@currentEmail" readonly />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.new_email") *</label>
                                    <input type="email" class="form-control" @bind="newEmail" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.password") *</label>
                                    <input type="password" class="form-control" @bind="emailChangePassword" required />
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" disabled="@isChangingEmail">
                                    @if (isChangingEmail)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check"></i>
                                    @GetLocalizedText("security.change_email")
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Telefon Değiştirme -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-telephone"></i>
                            @GetLocalizedText("security.change_phone")
                        </h4>
                    </div>
                    <div class="card-body">
                        <form @onsubmit="ChangePhone">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.current_phone")</label>
                                    <input type="tel" class="form-control" value="@currentPhone" readonly />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.new_phone") *</label>
                                    <input type="tel" class="form-control" @bind="newPhone" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">@GetLocalizedText("security.password") *</label>
                                    <input type="password" class="form-control" @bind="phoneChangePassword" required />
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" disabled="@isChangingPhone">
                                    @if (isChangingPhone)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check"></i>
                                    @GetLocalizedText("security.change_phone")
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- İki Faktörlü Doğrulama -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-shield-check"></i>
                            @GetLocalizedText("security.two_factor_auth")
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6>@GetLocalizedText("security.enhance_security")</h6>
                                <p class="text-muted mb-0">
                                    @GetLocalizedText("security.two_factor_description")
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" checked="@twoFactorEnabled" @onchange="OnTwoFactorCheckboxChanged">
                                    <label class="form-check-label">
                                        @(twoFactorEnabled ? GetLocalizedText("security.active") : GetLocalizedText("security.inactive"))
                                    </label>
                                </div>
                            </div>
                        </div>
                        @if (twoFactorEnabled)
                        {
                            <div class="mt-3 p-3 bg-success bg-opacity-10 rounded">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <span class="text-success">@GetLocalizedText("security.two_factor_enabled")</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Oturum Yönetimi -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-laptop"></i>
                            @GetLocalizedText("security.active_sessions")
                        </h4>
                        <button class="btn btn-outline-danger btn-sm" @onclick="LogoutAllDevices">
                            <i class="bi bi-x-circle"></i>
                            @GetLocalizedText("security.logout_all_devices")
                        </button>
                    </div>
                    <div class="card-body">
                        @if (activeSessions?.Any() == true)
                        {
                            @foreach (var session in activeSessions)
                            {
                                <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-2 @(session.IsCurrent ? "border-primary bg-primary bg-opacity-10" : "")">
                                    <div class="d-flex align-items-center">
                                        <i class="bi @GetDeviceIcon(session.DeviceType) me-3"></i>
                                        <div>
                                            <h6 class="mb-1">@session.DeviceName</h6>
                                            <small class="text-muted">@session.Location • @session.LastActivity.ToString("dd.MM.yyyy HH:mm")</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        @if (session.IsCurrent)
                                        {
                                            <span class="badge bg-primary me-2">@GetLocalizedText("security.current_session")</span>
                                        }
                                        @if (!session.IsCurrent)
                                        {
                                            <button class="btn btn-outline-danger btn-sm" @onclick="@(() => LogoutDevice(session.Id))">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-3">
                                <i class="bi bi-laptop display-4 text-muted mb-3"></i>
                                <p class="text-muted">@GetLocalizedText("security.no_active_sessions")</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Yan Panel -->
            <div class="col-lg-4">
                <!-- Güvenlik Durumu -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check"></i>
                            @GetLocalizedText("security.security_status")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="security-score mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>@GetLocalizedText("security.security_score")</span>
                                <span class="fw-bold @GetSecurityScoreClass(securityScore)">@securityScore/100</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar @GetSecurityScoreClass(securityScore)" 
                                     style="width: @(securityScore)%"></div>
                            </div>
                        </div>
                        
                        <div class="security-checklist">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi @(hasStrongPassword ? "bi-check-circle text-success" : "bi-x-circle text-danger") me-2"></i>
                                <small>@GetLocalizedText("security.strong_password")</small>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi @(twoFactorEnabled ? "bi-check-circle text-success" : "bi-x-circle text-danger") me-2"></i>
                                <small>@GetLocalizedText("security.two_factor_auth")</small>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi @(hasVerifiedEmail ? "bi-check-circle text-success" : "bi-x-circle text-danger") me-2"></i>
                                <small>@GetLocalizedText("security.verified_email")</small>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi @(hasVerifiedPhone ? "bi-check-circle text-success" : "bi-x-circle text-danger") me-2"></i>
                                <small>@GetLocalizedText("security.verified_phone")</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Güvenlik İpuçları -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-lightbulb"></i>
                            @GetLocalizedText("security.security_tips")
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-check text-success me-2"></i>
                                <small>@GetLocalizedText("security.tip_strong_password")</small>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check text-success me-2"></i>
                                <small>@GetLocalizedText("security.tip_two_factor")</small>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check text-success me-2"></i>
                                <small>@GetLocalizedText("security.tip_monitor_activity")</small>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check text-success me-2"></i>
                                <small>@GetLocalizedText("security.tip_trusted_devices")</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isChangingPassword = false;
    private bool isChangingEmail = false;
    private bool isChangingPhone = false;
    private bool twoFactorEnabled = false;
    private bool hasStrongPassword = true;
    private bool hasVerifiedEmail = true;
    private bool hasVerifiedPhone = true;
    private int securityScore = 85;
    private string currentEmail = "osmanali@example.com";
    private string currentPhone = "+90 555 123 45 67";
    private string newEmail = string.Empty;
    private string newPhone = string.Empty;
    private string emailChangePassword = string.Empty;
    private string phoneChangePassword = string.Empty;
    private ChangePasswordRequest changePasswordRequest = new();
    private List<ActiveSessionResponse>? activeSessions;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadSecurityInfo();
        }
        isLoading = false;
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadSecurityInfo();
        }
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private async Task LoadSecurityInfo()
    {
        try
        {
            isLoading = true;
            var securityInfo = await SecurityService.GetSecurityInfoAsync();
            
            if (securityInfo != null)
            {
                twoFactorEnabled = securityInfo.TwoFactorEnabled;
                hasVerifiedEmail = securityInfo.HasVerifiedEmail;
                hasVerifiedPhone = securityInfo.HasVerifiedPhone;
                hasStrongPassword = securityInfo.HasStrongPassword;
                securityScore = securityInfo.SecurityScore;
                currentEmail = securityInfo.CurrentEmail;
                currentPhone = securityInfo.CurrentPhone;
                activeSessions = securityInfo.ActiveSessions;
            }
            else
            {
                // API'den veri alınamadı, fallback değerleri
                activeSessions = new List<ActiveSessionResponse>();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", GetLocalizedText("security.loading_error") + ": " + ex.Message);
            activeSessions = new List<ActiveSessionResponse>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ChangePassword()
    {
        try
        {
            isChangingPassword = true;
            var success = await UserService.ChangePasswordAsync(changePasswordRequest);
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "Şifre başarıyla değiştirildi!");
                changePasswordRequest = new ChangePasswordRequest();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "Şifre değiştirilirken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isChangingPassword = false;
        }
    }

    private async Task ChangeEmail()
    {
        try
        {
            isChangingEmail = true;
            
            if (string.IsNullOrWhiteSpace(newEmail))
            {
                await JSRuntime.InvokeVoidAsync("showError", "Lütfen yeni e-posta adresini girin.");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(emailChangePassword))
            {
                await JSRuntime.InvokeVoidAsync("showError", "Lütfen şifrenizi girin.");
                return;
            }
            
            var request = new ChangeEmailRequest
            {
                NewEmail = newEmail,
                Password = emailChangePassword
            };
            
            var success = await SecurityService.ChangeEmailAsync(request);
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "E-posta değiştirme isteği gönderildi! Yeni e-posta adresinizi kontrol edin.");
                newEmail = string.Empty;
                emailChangePassword = string.Empty;
                await LoadSecurityInfo(); // Bilgileri yeniden yükle
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "E-posta değiştirme isteği gönderilirken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isChangingEmail = false;
        }
    }

    private async Task ChangePhone()
    {
        try
        {
            isChangingPhone = true;
            
            if (string.IsNullOrWhiteSpace(newPhone))
            {
                await JSRuntime.InvokeVoidAsync("showError", "Lütfen yeni telefon numarasını girin.");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(phoneChangePassword))
            {
                await JSRuntime.InvokeVoidAsync("showError", "Lütfen şifrenizi girin.");
                return;
            }
            
            var request = new ChangePhoneRequest
            {
                NewPhone = newPhone,
                Password = phoneChangePassword
            };
            
            var success = await SecurityService.ChangePhoneAsync(request);
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "Telefon değiştirme isteği gönderildi! SMS ile doğrulama kodu gönderilecek.");
                newPhone = string.Empty;
                phoneChangePassword = string.Empty;
                await LoadSecurityInfo(); // Bilgileri yeniden yükle
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "Telefon değiştirme isteği gönderilirken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isChangingPhone = false;
        }
    }

    private async Task OnTwoFactorCheckboxChanged(ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        var oldValue = twoFactorEnabled;
        
        // Önce UI'ı güncelle
        twoFactorEnabled = newValue;
        
        try
        {
            var success = await SecurityService.ToggleTwoFactorAsync(newValue);
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", 
                    newValue ? "İki faktörlü doğrulama aktifleştirildi!" : "İki faktörlü doğrulama devre dışı bırakıldı!");
                await LoadSecurityInfo(); // Bilgileri yeniden yükle
            }
            else
            {
                // Başarısız olursa eski değere geri dön
                twoFactorEnabled = oldValue;
                await InvokeAsync(StateHasChanged);
                await JSRuntime.InvokeVoidAsync("showError", 
                    "İki faktörlü doğrulama ayarı değiştirilirken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            // Hata durumunda eski değere geri dön
            twoFactorEnabled = oldValue;
            await InvokeAsync(StateHasChanged);
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
    }

    private async Task LogoutDevice(Guid sessionId)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bu cihazdan çıkış yapmak istediğinizden emin misiniz?");
            if (!confirmed) return;

            var success = await SecurityService.LogoutDeviceAsync(sessionId);
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "Cihazdan çıkış yapıldı!");
                await LoadSecurityInfo();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "Cihazdan çıkış yapılırken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
    }

    private async Task LogoutAllDevices()
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Tüm cihazlardan çıkış yapmak istediğinizden emin misiniz?");
            if (!confirmed) return;

            var success = await SecurityService.LogoutAllDevicesAsync();
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "Tüm cihazlardan çıkış yapıldı!");
                
                // Tüm cihazlardan çıkış yapıldıysa, mevcut oturum da sonlandırılabilir
                // Kullanıcıyı login sayfasına yönlendir
                await Task.Delay(1000);
                await AuthService.LogoutAsync();
                Navigation.NavigateTo("/login", forceLoad: true);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "Tüm cihazlardan çıkış yapılırken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
    }

    private string GetDeviceIcon(string deviceType)
    {
        return deviceType switch
        {
            "Desktop" => "bi-laptop",
            "Mobile" => "bi-phone",
            "Tablet" => "bi-tablet",
            _ => "bi-device-hdd"
        };
    }

    private string GetSecurityScoreClass(int score)
    {
        return score switch
        {
            >= 80 => "bg-success",
            >= 60 => "bg-warning",
            _ => "bg-danger"
        };
    }

    private string GetLocalizedText(string key)
    {
        return LocalizationService.GetString(key);
    }
}

