@page "/settings"
@inject UserService UserService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject LocalizationService LocalizationService
@implements IDisposable

<PageTitle>@GetLocalizedText("settings.title") - Getir</PageTitle>

@if (!isAuthenticated)
{
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-person-x display-1 text-warning mb-4"></i>
                        <h3>@GetLocalizedText("common.login")</h3>
                        <p class="text-muted mb-4">
                            @GetLocalizedText("settings.login_required")
                        </p>
                        <a href="/login" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i>
                            @GetLocalizedText("common.login")
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@GetLocalizedText("common.loading")</span>
        </div>
        <p class="mt-3">@GetLocalizedText("settings.loading_settings")</p>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">@GetLocalizedText("common.home")</a></li>
                <li class="breadcrumb-item active" aria-current="page">@GetLocalizedText("settings.title")</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-gear"></i>
                            @GetLocalizedText("settings.account_settings")
                        </h4>
                    </div>
                    <div class="card-body">
                        <form @onsubmit="SaveSettings">
                            <!-- Profil Ayarları -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-person"></i>
                                    @GetLocalizedText("settings.profile_settings")
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">@GetLocalizedText("profile.first_name")</label>
                                        <input type="text" class="form-control" @bind="settings.FirstName" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">@GetLocalizedText("profile.last_name")</label>
                                        <input type="text" class="form-control" @bind="settings.LastName" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">@GetLocalizedText("profile.email")</label>
                                        <input type="email" class="form-control" @bind="settings.Email" readonly />
                                        <small class="text-muted">@GetLocalizedText("profile.email_change_note")</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">@GetLocalizedText("profile.phone")</label>
                                        <input type="tel" class="form-control" @bind="settings.Phone" />
                                    </div>
                                </div>
                            </div>

                            <!-- Bildirim Ayarları -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-bell"></i>
                                    @GetLocalizedText("settings.notification_settings")
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.EmailNotifications">
                                            <label class="form-check-label">@GetLocalizedText("notifications.email_notifications")</label>
                                        </div>
                                        <small class="text-muted">@GetLocalizedText("notifications.email_notifications_desc")</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.SmsNotifications">
                                            <label class="form-check-label">@GetLocalizedText("notifications.sms_notifications")</label>
                                        </div>
                                        <small class="text-muted">@GetLocalizedText("notifications.sms_notifications_desc")</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.PushNotifications">
                                            <label class="form-check-label">@GetLocalizedText("notifications.push_notifications")</label>
                                        </div>
                                        <small class="text-muted">@GetLocalizedText("notifications.push_notifications_desc")</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.MarketingEmails">
                                            <label class="form-check-label">@GetLocalizedText("notifications.marketing_emails")</label>
                                        </div>
                                        <small class="text-muted">@GetLocalizedText("notifications.marketing_emails_desc")</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Dil ve Bölge -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-globe"></i>
                                    @GetLocalizedText("settings.language_region")
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">@GetLocalizedText("settings.language")</label>
                                        <select class="form-select" @bind="settings.Language">
                                            <option value="tr">@GetLocalizedText("languages.turkish")</option>
                                            <option value="en">@GetLocalizedText("languages.english")</option>
                                            <option value="ar">@GetLocalizedText("languages.arabic")</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">@GetLocalizedText("settings.currency")</label>
                                        <select class="form-select" @bind="settings.Currency">
                                            <option value="TRY">₺ @GetLocalizedText("currencies.turkish_lira")</option>
                                            <option value="USD">$ @GetLocalizedText("currencies.us_dollar")</option>
                                            <option value="EUR">€ @GetLocalizedText("currencies.euro")</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Gizlilik Ayarları -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-shield-lock"></i>
                                    @GetLocalizedText("settings.privacy_settings")
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.ProfileVisibility">
                                            <label class="form-check-label">@GetLocalizedText("privacy.profile_visibility")</label>
                                        </div>
                                        <small class="text-muted">@GetLocalizedText("privacy.profile_visibility_desc")</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.DataSharing">
                                            <label class="form-check-label">@GetLocalizedText("privacy.data_sharing")</label>
                                        </div>
                                        <small class="text-muted">@GetLocalizedText("privacy.data_sharing_desc")</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Kaydet Butonu -->
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check"></i>
                                    @GetLocalizedText("common.save")
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Yan Panel -->
            <div class="col-lg-4">
                <!-- Hızlı Erişim -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning"></i>
                            @GetLocalizedText("settings.quick_access")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/security" class="btn btn-outline-primary">
                                <i class="bi bi-shield-lock"></i>
                                @GetLocalizedText("settings.security_settings")
                            </a>
                            <a href="/addresses" class="btn btn-outline-primary">
                                <i class="bi bi-geo-alt"></i>
                                @GetLocalizedText("settings.address_management")
                            </a>
                            <a href="/notifications" class="btn btn-outline-primary">
                                <i class="bi bi-bell"></i>
                                @GetLocalizedText("settings.notifications")
                            </a>
                            <a href="/permissions" class="btn btn-outline-primary">
                                <i class="bi bi-key"></i>
                                @GetLocalizedText("settings.permissions")
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Hesap İstatistikleri -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up"></i>
                            @GetLocalizedText("settings.account_statistics")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-primary">@totalOrders</h4>
                                    <small class="text-muted">@GetLocalizedText("statistics.total_orders")</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-success">@totalSpent.ToString("C0")</h4>
                                    <small class="text-muted">@GetLocalizedText("statistics.total_spent")</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-info">@favoriteCount</h4>
                                    <small class="text-muted">@GetLocalizedText("statistics.favorite_products")</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-warning">@addressCount</h4>
                                    <small class="text-muted">@GetLocalizedText("statistics.saved_addresses")</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private UserSettings settings = new();
    private int totalOrders = 0;
    private decimal totalSpent = 0;
    private int favoriteCount = 0;
    private int addressCount = 0;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadSettings();
        }
        isLoading = false;
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadSettings();
        }
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private string GetLocalizedText(string key)
    {
        return LocalizationService.GetString(key);
    }

    private async Task LoadSettings()
    {
        try
        {
            isLoading = true;
            // TODO: API'den kullanıcı ayarlarını çek
            // settings = await UserService.GetUserSettingsAsync();
            
            // Şimdilik mock data
            settings = new UserSettings
            {
                FirstName = "Osman Ali",
                LastName = "Aydemir",
                Email = "osmanali@example.com",
                Phone = "+90 555 123 45 67",
                EmailNotifications = true,
                SmsNotifications = true,
                PushNotifications = true,
                MarketingEmails = false,
                Language = "tr",
                Currency = "TRY",
                ProfileVisibility = true,
                DataSharing = false
            };

            // İstatistikleri yükle
            await LoadStatistics();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Ayarlar yüklenirken bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task LoadStatistics()
    {
        try
        {
            // TODO: API'den istatistikleri çek
            // var stats = await UserService.GetUserStatisticsAsync();
            
            // Şimdilik mock data
            totalOrders = 15;
            totalSpent = 1250.75m;
            favoriteCount = 8;
            addressCount = 3;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading statistics: {ex.Message}");
        }
        
        return Task.CompletedTask;
    }

    private async Task SaveSettings()
    {
        try
        {
            isSaving = true;
            
            // Dil değişikliğini LocalizationService'e bildir
            if (!string.IsNullOrEmpty(settings.Language))
            {
                LocalizationService.SetCulture(settings.Language);
                
                // HTML lang ve dir attribute'larını güncelle
                await JSRuntime.InvokeVoidAsync("updateLanguageAttributes", settings.Language);
                
                Console.WriteLine($"Settings - Language changed to: {settings.Language}");
            }
            
            // TODO: API'ye ayarları kaydet
            // var success = await UserService.UpdateUserSettingsAsync(settings);
            
            // Şimdilik mock işlem
            var success = true;
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "Ayarlar başarıyla kaydedildi!");
                
                // Sayfayı yenile ki yeni dil aktif olsun
                await Task.Delay(1000); // Kullanıcı mesajı görebilsin
                Navigation.NavigateTo("/settings", forceLoad: true);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "Ayarlar kaydedilirken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }
}

@* Settings Model *@
@code {
    public class UserSettings
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public bool EmailNotifications { get; set; } = true;
        public bool SmsNotifications { get; set; } = true;
        public bool PushNotifications { get; set; } = true;
        public bool MarketingEmails { get; set; } = false;
        public string Language { get; set; } = "tr";
        public string Currency { get; set; } = "TRY";
        public bool ProfileVisibility { get; set; } = true;
        public bool DataSharing { get; set; } = false;
    }
}
