@page "/settings"
@inject UserService UserService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Ayarlar - Getir</PageTitle>

@if (!isAuthenticated)
{
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-person-x display-1 text-warning mb-4"></i>
                        <h3>Giriş Yapın</h3>
                        <p class="text-muted mb-4">
                            Ayarlarınızı görüntülemek için giriş yapmanız gerekiyor.
                        </p>
                        <a href="/login" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i>
                            Giriş Yap
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p class="mt-3">Ayarlarınız yükleniyor...</p>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
                <li class="breadcrumb-item active" aria-current="page">Ayarlar</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-gear"></i>
                            Hesap Ayarları
                        </h4>
                    </div>
                    <div class="card-body">
                        <form @onsubmit="SaveSettings">
                            <!-- Profil Ayarları -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-person"></i>
                                    Profil Bilgileri
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Ad</label>
                                        <input type="text" class="form-control" @bind="settings.FirstName" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Soyad</label>
                                        <input type="text" class="form-control" @bind="settings.LastName" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">E-posta</label>
                                        <input type="email" class="form-control" @bind="settings.Email" readonly />
                                        <small class="text-muted">E-posta adresinizi değiştirmek için güvenlik sayfasını kullanın.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Telefon</label>
                                        <input type="tel" class="form-control" @bind="settings.Phone" />
                                    </div>
                                </div>
                            </div>

                            <!-- Bildirim Ayarları -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-bell"></i>
                                    Bildirim Ayarları
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.EmailNotifications">
                                            <label class="form-check-label">E-posta Bildirimleri</label>
                                        </div>
                                        <small class="text-muted">Sipariş durumu ve kampanyalar hakkında e-posta alın.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.SmsNotifications">
                                            <label class="form-check-label">SMS Bildirimleri</label>
                                        </div>
                                        <small class="text-muted">Önemli güncellemeler için SMS alın.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.PushNotifications">
                                            <label class="form-check-label">Push Bildirimleri</label>
                                        </div>
                                        <small class="text-muted">Tarayıcı bildirimleri alın.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.MarketingEmails">
                                            <label class="form-check-label">Pazarlama E-postaları</label>
                                        </div>
                                        <small class="text-muted">Kampanya ve özel teklifler hakkında bilgi alın.</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Dil ve Bölge -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-globe"></i>
                                    Dil ve Bölge
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Dil</label>
                                        <select class="form-select" @bind="settings.Language">
                                            <option value="tr">Türkçe</option>
                                            <option value="en">English</option>
                                            <option value="ar">العربية</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Para Birimi</label>
                                        <select class="form-select" @bind="settings.Currency">
                                            <option value="TRY">₺ Türk Lirası</option>
                                            <option value="USD">$ Amerikan Doları</option>
                                            <option value="EUR">€ Euro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Gizlilik Ayarları -->
                            <div class="settings-section mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-shield-lock"></i>
                                    Gizlilik Ayarları
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.ProfileVisibility">
                                            <label class="form-check-label">Profil Görünürlüğü</label>
                                        </div>
                                        <small class="text-muted">Profilinizi diğer kullanıcılara gösterin.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" @bind="settings.DataSharing">
                                            <label class="form-check-label">Veri Paylaşımı</label>
                                        </div>
                                        <small class="text-muted">Anonim verilerinizi analiz için paylaşın.</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Kaydet Butonu -->
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check"></i>
                                    Ayarları Kaydet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Yan Panel -->
            <div class="col-lg-4">
                <!-- Hızlı Erişim -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning"></i>
                            Hızlı Erişim
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/security" class="btn btn-outline-primary">
                                <i class="bi bi-shield-lock"></i>
                                Güvenlik Ayarları
                            </a>
                            <a href="/addresses" class="btn btn-outline-primary">
                                <i class="bi bi-geo-alt"></i>
                                Adres Yönetimi
                            </a>
                            <a href="/notifications" class="btn btn-outline-primary">
                                <i class="bi bi-bell"></i>
                                Bildirimler
                            </a>
                            <a href="/permissions" class="btn btn-outline-primary">
                                <i class="bi bi-key"></i>
                                İzinler
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Hesap İstatistikleri -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up"></i>
                            Hesap İstatistikleri
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-primary">@totalOrders</h4>
                                    <small class="text-muted">Toplam Sipariş</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-success">@totalSpent.ToString("C0")</h4>
                                    <small class="text-muted">Toplam Harcama</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-info">@favoriteCount</h4>
                                    <small class="text-muted">Favori Ürün</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <h4 class="text-warning">@addressCount</h4>
                                    <small class="text-muted">Kayıtlı Adres</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private UserSettings settings = new();
    private int totalOrders = 0;
    private decimal totalSpent = 0;
    private int favoriteCount = 0;
    private int addressCount = 0;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadSettings();
        }
        isLoading = false;
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadSettings();
        }
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private async Task LoadSettings()
    {
        try
        {
            isLoading = true;
            // TODO: API'den kullanıcı ayarlarını çek
            // settings = await UserService.GetUserSettingsAsync();
            
            // Şimdilik mock data
            settings = new UserSettings
            {
                FirstName = "Osman Ali",
                LastName = "Aydemir",
                Email = "osmanali@example.com",
                Phone = "+90 555 123 45 67",
                EmailNotifications = true,
                SmsNotifications = true,
                PushNotifications = true,
                MarketingEmails = false,
                Language = "tr",
                Currency = "TRY",
                ProfileVisibility = true,
                DataSharing = false
            };

            // İstatistikleri yükle
            await LoadStatistics();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Ayarlar yüklenirken bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task LoadStatistics()
    {
        try
        {
            // TODO: API'den istatistikleri çek
            // var stats = await UserService.GetUserStatisticsAsync();
            
            // Şimdilik mock data
            totalOrders = 15;
            totalSpent = 1250.75m;
            favoriteCount = 8;
            addressCount = 3;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading statistics: {ex.Message}");
        }
        
        return Task.CompletedTask;
    }

    private async Task SaveSettings()
    {
        try
        {
            isSaving = true;
            // TODO: API'ye ayarları kaydet
            // var success = await UserService.UpdateUserSettingsAsync(settings);
            
            // Şimdilik mock işlem
            var success = true;
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("showSuccess", "Ayarlar başarıyla kaydedildi!");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("showError", "Ayarlar kaydedilirken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showError", "Bir hata oluştu: " + ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }
}

@* Settings Model *@
@code {
    public class UserSettings
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public bool EmailNotifications { get; set; } = true;
        public bool SmsNotifications { get; set; } = true;
        public bool PushNotifications { get; set; } = true;
        public bool MarketingEmails { get; set; } = false;
        public string Language { get; set; } = "tr";
        public string Currency { get; set; } = "TRY";
        public bool ProfileVisibility { get; set; } = true;
        public bool DataSharing { get; set; } = false;
    }
}
