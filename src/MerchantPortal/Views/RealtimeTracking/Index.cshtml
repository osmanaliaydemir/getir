@model Getir.MerchantPortal.Models.RealtimeTrackingViewModel
@inject ILocalizationService LocalizationService

@{
    ViewData["Title"] = LocalizationService.GetString("RealtimeTracking");
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">@LocalizationService.GetString("RealtimeTracking")</h1>
        <p class="text-muted mb-0">@LocalizationService.GetString("RealtimeTrackingDescription")</p>
    </div>
</div>

@if (TempData["Success"] is string successMessage)
{
    <div class="alert alert-success">@successMessage</div>
}
@if (TempData["Error"] is string errorMessage)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@LocalizationService.GetString("ActiveTrackings")</h5>
                <span class="badge bg-secondary-subtle text-secondary">@Model.ActiveTrackings.Count</span>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.ActiveTrackings.Any())
                {
                    foreach (var tracking in Model.ActiveTrackings.OrderByDescending(t => t.LastUpdatedAt))
                    {
                        var isSelected = Model.SelectedTracking?.Id == tracking.Id;
                        <a class="list-group-item list-group-item-action @(isSelected ? "active" : "")"
                           href="@Url.Action("Index", new { trackingId = tracking.Id })">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>#@tracking.OrderId.ToString().Substring(0, 8)</strong>
                                    <div class="small">@tracking.StatusDisplayName</div>
                                </div>
                                <div class="text-end">
                                    @if (tracking.EstimatedMinutesRemaining.HasValue)
                                    {
                                        <div class="small text-muted">@tracking.EstimatedMinutesRemaining.Value @LocalizationService.GetString("MinutesRemaining")</div>
                                    }
                                    <div class="small text-muted">@tracking.LastUpdatedAt.ToLocalTime().ToString("g")</div>
                                </div>
                            </div>
                        </a>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted text-center py-3">
                        @LocalizationService.GetString("NoActiveTrackings")
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        @if (Model.SelectedTracking != null)
        {
            var tracking = Model.SelectedTracking;
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">@LocalizationService.GetString("TrackingDetails")</h5>
                    <span class="badge bg-primary-subtle text-primary">@tracking.StatusDisplayName</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">@LocalizationService.GetString("Order")</h6>
                            <p class="mb-2">
                                <strong>#@tracking.OrderId</strong><br />
                                <span class="text-muted small">@LocalizationService.GetString("CreatedAt"): @tracking.CreatedAt.ToLocalTime().ToString("g")</span>
                            </p>
                            <h6 class="text-muted">@LocalizationService.GetString("Courier")</h6>
                            <p class="mb-2">
                                @if (!string.IsNullOrEmpty(tracking.CourierName))
                                {
                                    <span>@tracking.CourierName</span>
                                    if (!string.IsNullOrEmpty(tracking.CourierPhone))
                                    {
                                        <br /><span class="text-muted small">@tracking.CourierPhone</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">@LocalizationService.GetString("CourierNotAssigned")</span>
                                }
                            </p>
                            <h6 class="text-muted">@LocalizationService.GetString("Location")</h6>
                            <p class="mb-0">
                                @if (tracking.Latitude.HasValue && tracking.Longitude.HasValue)
                                {
                                    <span>@string.Format("{0:F5}, {1:F5}", tracking.Latitude.Value, tracking.Longitude.Value)</span><br />
                                }
                                <span class="text-muted">@tracking.Address ?? LocalizationService.GetString("AddressUnknown")</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">@LocalizationService.GetString("Timing")</h6>
                            <ul class="list-unstyled mb-3">
                                <li>
                                    <strong>@LocalizationService.GetString("EstimatedArrival"):</strong>
                                    @if (tracking.EstimatedArrivalTime.HasValue)
                                    {
                                        @tracking.EstimatedArrivalTime.Value.ToLocalTime().ToString("t")
                                    }
                                    else
                                    {
                                        <span class="text-muted">@LocalizationService.GetString("Unknown")</span>
                                    }
                                </li>
                                <li>
                                    <strong>@LocalizationService.GetString("MinutesRemaining"):</strong>
                                    @(tracking.EstimatedMinutesRemaining?.ToString() ?? LocalizationService.GetString("Unknown"))
                                </li>
                                <li>
                                    <strong>@LocalizationService.GetString("DistanceToDestination"):</strong>
                                    @(tracking.DistanceFromDestination?.ToString("F2") ?? "0") km
                                </li>
                            </ul>

                            <div class="alert alert-info">
                                <strong>@LocalizationService.GetString("StatusMessage")</strong><br />
                                @if (!string.IsNullOrWhiteSpace(tracking.StatusMessage))
                                {
                                    @tracking.StatusMessage
                                }
                                else
                                {
                                    <span class="text-muted">@LocalizationService.GetString("NoStatusMessage")</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">@LocalizationService.GetString("UpdateStatus")</h5>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateStatus" method="post" class="row g-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="OrderTrackingId" value="@tracking.Id" />
                        <div class="col-md-4">
                            <label class="form-label">@LocalizationService.GetString("Status")</label>
                            <select class="form-select" name="Status">
                                @{
                                    var statuses = new Dictionary<int, string>
                                    {
                                        {1, "OrderPlaced"},
                                        {2, "OrderConfirmed"},
                                        {3, "Preparing"},
                                        {4, "ReadyForPickup"},
                                        {5, "PickedUp"},
                                        {6, "OnTheWay"},
                                        {7, "NearDestination"},
                                        {8, "Arrived"},
                                        {9, "Delivered"},
                                        {10, "Cancelled"}
                                    };
                                    foreach (var status in statuses)
                                    {
                                        <option value="@status.Key" selected="@(status.Key == tracking.Status ? "selected" : null)">
                                            @LocalizationService.GetString(status.Value)
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">@LocalizationService.GetString("StatusMessage")</label>
                            <input type="text" class="form-control" name="StatusMessage" value="@tracking.StatusMessage" />
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> @LocalizationService.GetString("Save")
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">@LocalizationService.GetString("RecentNotifications")</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>@LocalizationService.GetString("Title")</th>
                                <th>@LocalizationService.GetString("Type")</th>
                                <th>@LocalizationService.GetString("SentAt")</th>
                                <th>@LocalizationService.GetString("Status")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Notifications.Any())
                            {
                                foreach (var notification in Model.Notifications.OrderByDescending(n => n.CreatedAt))
                                {
                                    <tr>
                                        <td>@notification.Title</td>
                                        <td>@notification.TypeDisplayName</td>
                                        <td>@notification.CreatedAt.ToLocalTime().ToString("g")</td>
                                        <td>
                                            @if (notification.IsSent)
                                            {
                                                <span class="badge bg-success-subtle text-success">@LocalizationService.GetString("Sent")</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning-subtle text-warning">@LocalizationService.GetString("Pending")</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">
                                        @LocalizationService.GetString("NoNotifications")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="card h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    <i class="bi bi-map text-primary" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">@LocalizationService.GetString("SelectTrackingFromList")</p>
                </div>
            </div>
        }
    </div>
</div>

