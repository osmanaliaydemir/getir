@inject ILocalizationService LocalizationService
@{
    ViewData["Title"] = LocalizationService.GetString("Notifications");
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard-modern.css" />
    <style>
        .settings-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 1.5rem;
        }
        
        .settings-card h5 {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-card h5 i {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-radius: 12px;
            background: #f9fafb;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .setting-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .setting-info h6 {
            margin: 0;
            font-weight: 600;
            color: #111827;
        }
        
        .setting-info small {
            color: #6b7280;
        }
        
        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
            cursor: pointer;
        }
        
        .form-switch .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        .time-picker-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sound-test-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            transition: all 0.2s ease;
        }
        
        .sound-test-btn:hover {
            border-color: #667eea;
            background: #f9fafb;
        }
    </style>
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-bell me-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
            Bildirim Tercihleri
        </h2>
        <p class="text-muted mb-0">Bildirim ayarlarÄ±nÄ±zÄ± yÃ¶netin</p>
    </div>
    <button type="button" class="btn" style="background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%); color: white; border-radius: 10px;" onclick="saveAllPreferences()">
        <i class="fas fa-save me-2"></i>TÃ¼mÃ¼nÃ¼ Kaydet
    </button>
</div>

<!-- General Notifications -->
<div class="settings-card fade-in" style="animation-delay: 0.1s;">
    <h5>
        <i class="fas fa-bell"></i>
        Genel Bildirimler
    </h5>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6>Ses Bildirimleri</h6>
            <small>Yeni sipariÅŸ ve durum deÄŸiÅŸikliklerinde ses Ã§alsÄ±n</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="soundEnabled" checked>
        </div>
    </div>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6>MasaÃ¼stÃ¼ Bildirimleri</h6>
            <small>Browser push notifications (tarayÄ±cÄ± izni gerekir)</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="desktopNotifications" checked>
        </div>
    </div>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6>E-posta Bildirimleri</h6>
            <small>Ã–nemli olaylar iÃ§in e-posta gÃ¶nder</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="emailNotifications">
        </div>
    </div>
</div>

<!-- Event-Specific Notifications -->
<div class="settings-card fade-in" style="animation-delay: 0.2s;">
    <h5>
        <i class="fas fa-filter"></i>
        Olay BazlÄ± Bildirimler
    </h5>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6><i class="fas fa-shopping-bag text-success me-2"></i>Yeni SipariÅŸ</h6>
            <small>MÃ¼ÅŸteriden yeni sipariÅŸ geldiÄŸinde bildir</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="newOrderNotifications" checked>
        </div>
    </div>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6><i class="fas fa-sync text-info me-2"></i>Durum DeÄŸiÅŸiklikleri</h6>
            <small>SipariÅŸ durumu deÄŸiÅŸtiÄŸinde bildir</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="statusChangeNotifications" checked>
        </div>
    </div>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6><i class="fas fa-times-circle text-danger me-2"></i>Ä°ptal Bildirimleri</h6>
            <small>SipariÅŸ iptal edildiÄŸinde bildir</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="cancellationNotifications" checked>
        </div>
    </div>
</div>

<!-- Sound Settings -->
<div class="settings-card fade-in" style="animation-delay: 0.3s;">
    <h5>
        <i class="fas fa-volume-up"></i>
        Ses AyarlarÄ±
    </h5>
    
    <div class="setting-item">
        <div class="setting-info flex-grow-1">
            <h6>Bildirim Sesi</h6>
            <small>SipariÅŸ bildirimi iÃ§in kullanÄ±lacak ses</small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <select class="form-select" id="notificationSound" style="width: 250px;">
                <option value="default">ğŸ”” VarsayÄ±lan (Klasik)</option>
                <option value="chime">ğŸµ Chime (Melodik)</option>
                <option value="bell">ğŸ”” Bell (Zarif)</option>
                <option value="ding">âœ¨ Ding (HÄ±zlÄ±)</option>
                <option value="ping">ğŸ’« Ping (Hafif)</option>
            </select>
            <button type="button" class="sound-test-btn" onclick="testNotificationSound()">
                <i class="fas fa-play"></i> Test
            </button>
        </div>
    </div>
</div>

<!-- Do Not Disturb -->
<div class="settings-card fade-in" style="animation-delay: 0.4s;">
    <h5>
        <i class="fas fa-moon"></i>
        RahatsÄ±z Etme Modu
    </h5>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6>RahatsÄ±z Etme Modunu EtkinleÅŸtir</h6>
            <small>Belirli saatler arasÄ±nda bildirim alma</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="doNotDisturbEnabled" onchange="toggleDNDTimeInputs()">
        </div>
    </div>
    
    <div id="dndTimeInputs" style="display: none;">
        <div class="setting-item">
            <div class="setting-info">
                <h6>BaÅŸlangÄ±Ã§ Saati</h6>
                <small>RahatsÄ±z etme baÅŸlangÄ±Ã§</small>
            </div>
            <input type="time" class="form-control" id="dndStartTime" value="22:00" style="width: 150px;">
        </div>
        
        <div class="setting-item">
            <div class="setting-info">
                <h6>BitiÅŸ Saati</h6>
                <small>RahatsÄ±z etme bitiÅŸ</small>
            </div>
            <input type="time" class="form-control" id="dndEndTime" value="08:00" style="width: 150px;">
        </div>
    </div>
</div>

<!-- Desktop Notification Permission -->
<div class="settings-card fade-in" style="animation-delay: 0.5s;">
    <h5>
        <i class="fas fa-desktop"></i>
        MasaÃ¼stÃ¼ Bildirimleri
    </h5>
    
    <div class="alert alert-info">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <i class="fas fa-info-circle me-2"></i>
                <strong>TarayÄ±cÄ± Ä°zni:</strong>
                <span id="permissionStatus">Kontrol ediliyor...</span>
            </div>
            <button type="button" class="btn btn-primary btn-sm" id="requestPermissionBtn" style="display: none;" onclick="requestDesktopPermission()">
                <i class="fas fa-bell"></i> Ä°zin Ver
            </button>
        </div>
    </div>
    
    <div class="setting-item">
        <div class="setting-info">
            <h6>Test Bildirimi GÃ¶nder</h6>
            <small>MasaÃ¼stÃ¼ bildirimini test edin</small>
        </div>
        <button type="button" class="btn btn-outline-primary" onclick="sendTestDesktopNotification()">
            <i class="fas fa-paper-plane"></i> Test Et
        </button>
    </div>
</div>

@section Scripts {
    <script>
        let preferences = {};
        
        $(document).ready(function() {
            // Load saved preferences
            loadPreferences();
            
            // Check desktop notification permission
            checkDesktopNotificationPermission();
        });
        
        function loadPreferences() {
            // Load from API/Database
            $.ajax({
                url: '/Settings/GetNotificationPreferences',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        preferences = response.data;
                        
                        // Apply to UI
                        $('#soundEnabled').prop('checked', preferences.soundEnabled !== false);
                        $('#desktopNotifications').prop('checked', preferences.desktopNotifications !== false);
                        $('#emailNotifications').prop('checked', preferences.emailNotifications === true);
                        $('#newOrderNotifications').prop('checked', preferences.newOrderNotifications !== false);
                        $('#statusChangeNotifications').prop('checked', preferences.statusChangeNotifications !== false);
                        $('#cancellationNotifications').prop('checked', preferences.cancellationNotifications !== false);
                        $('#doNotDisturbEnabled').prop('checked', preferences.doNotDisturbEnabled === true);
                        $('#notificationSound').val(preferences.notificationSound || 'default');
                        
                        if (preferences.doNotDisturbEnabled) {
                            $('#dndTimeInputs').show();
                            if (preferences.doNotDisturbStart) {
                                $('#dndStartTime').val(preferences.doNotDisturbStart);
                            }
                            if (preferences.doNotDisturbEnd) {
                                $('#dndEndTime').val(preferences.doNotDisturbEnd);
                            }
                        }
                        
                        // Also save to localStorage for signalr-helper.js
                        localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
                    } else {
                        // Fallback to localStorage if API fails
                        loadPreferencesFromLocalStorage();
                    }
                },
                error: function() {
                    console.log('Failed to load preferences from API, falling back to localStorage');
                    loadPreferencesFromLocalStorage();
                }
            });
        }
        
        function loadPreferencesFromLocalStorage() {
            const saved = localStorage.getItem('notificationPreferences');
            if (saved) {
                preferences = JSON.parse(saved);
                
                // Apply to UI
                $('#soundEnabled').prop('checked', preferences.soundEnabled !== false);
                $('#desktopNotifications').prop('checked', preferences.desktopNotifications !== false);
                $('#emailNotifications').prop('checked', preferences.emailNotifications === true);
                $('#newOrderNotifications').prop('checked', preferences.newOrderNotifications !== false);
                $('#statusChangeNotifications').prop('checked', preferences.statusChangeNotifications !== false);
                $('#cancellationNotifications').prop('checked', preferences.cancellationNotifications !== false);
                $('#doNotDisturbEnabled').prop('checked', preferences.doNotDisturbEnabled === true);
                $('#notificationSound').val(preferences.notificationSound || 'default');
                
                if (preferences.doNotDisturbEnabled) {
                    $('#dndTimeInputs').show();
                    if (preferences.doNotDisturbStart) {
                        $('#dndStartTime').val(preferences.doNotDisturbStart);
                    }
                    if (preferences.doNotDisturbEnd) {
                        $('#dndEndTime').val(preferences.doNotDisturbEnd);
                    }
                }
            }
        }
        
        function saveAllPreferences() {
            preferences = {
                soundEnabled: $('#soundEnabled').is(':checked'),
                desktopNotifications: $('#desktopNotifications').is(':checked'),
                emailNotifications: $('#emailNotifications').is(':checked'),
                newOrderNotifications: $('#newOrderNotifications').is(':checked'),
                statusChangeNotifications: $('#statusChangeNotifications').is(':checked'),
                cancellationNotifications: $('#cancellationNotifications').is(':checked'),
                doNotDisturbEnabled: $('#doNotDisturbEnabled').is(':checked'),
                doNotDisturbStart: $('#dndStartTime').val(),
                doNotDisturbEnd: $('#dndEndTime').val(),
                notificationSound: $('#notificationSound').val()
            };
            
            // Save to API/Database
            $.ajax({
                url: '/Settings/SaveNotificationPreferences',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(preferences),
                success: function(response) {
                    if (response.success) {
                        // Also save to localStorage for signalr-helper.js
                        localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
                        
                        // Update signalr-helper.js settings
                        if (window.notificationSettings) {
                            window.notificationSettings = preferences;
                        }
                        
                        // Show success message
                        showSuccessToast(response.message || 'Bildirim tercihleri baÅŸarÄ±yla kaydedildi!');
                    } else {
                        showErrorToast(response.message || 'Tercihler kaydedilemedi');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Save preferences error:', error);
                    showErrorToast('Tercihler kaydedilirken bir hata oluÅŸtu: ' + error);
                }
            });
        }
        
        function toggleDNDTimeInputs() {
            const enabled = $('#doNotDisturbEnabled').is(':checked');
            $('#dndTimeInputs').toggle(enabled);
        }
        
        function checkDesktopNotificationPermission() {
            if (!("Notification" in window)) {
                $('#permissionStatus').text('Desteklenmiyor').addClass('text-danger');
                return;
            }
            
            const permission = Notification.permission;
            
            if (permission === "granted") {
                $('#permissionStatus').text('âœ… Ä°zin verildi').addClass('text-success');
                $('#requestPermissionBtn').hide();
            } else if (permission === "denied") {
                $('#permissionStatus').text('âŒ Ä°zin reddedildi (TarayÄ±cÄ± ayarlarÄ±ndan aÃ§Ä±n)').addClass('text-danger');
                $('#requestPermissionBtn').hide();
            } else {
                $('#permissionStatus').text('âš ï¸ Ä°zin verilmedi').addClass('text-warning');
                $('#requestPermissionBtn').show();
            }
        }
        
        function requestDesktopPermission() {
            if (!("Notification" in window)) {
                alert("TarayÄ±cÄ±nÄ±z desktop notifications desteklemiyor");
                return;
            }
            
            Notification.requestPermission().then(function(permission) {
                checkDesktopNotificationPermission();
                
                if (permission === "granted") {
                    sendTestDesktopNotification();
                }
            });
        }
        
        function sendTestDesktopNotification() {
            if (Notification.permission !== "granted") {
                alert("LÃ¼tfen Ã¶nce bildirim iznini verin");
                return;
            }
            
            new Notification("Getir Merchant Portal", {
                body: "Test bildirimi - Bildirimler doÄŸru Ã§alÄ±ÅŸÄ±yor! âœ…",
                icon: "/favicon.ico",
                badge: "/favicon.ico"
            });
        }
        
        function testNotificationSound() {
            const sound = $('#notificationSound').val();
            
            // Sound file mapping (same as signalr-helper.js)
            const soundFiles = {
                'default': '/sounds/notify-default.wav',
                'chime': '/sounds/notify-1.wav',
                'bell': '/sounds/notify-2.wav',
                'ding': '/sounds/notify-3.wav',
                'ping': '/sounds/notify-4.wav'
            };
            
            const soundFile = soundFiles[sound] || soundFiles['default'];
            
            try {
                const audio = new Audio(soundFile);
                audio.volume = 0.5;
                audio.play()
                    .then(() => {
                        showSuccessToast(`ğŸ”Š "${sound}" sesi test ediliyor...`);
                    })
                    .catch(err => {
                        console.error('Sound play failed:', err);
                        showErrorToast('Ses oynatÄ±lamadÄ±. TarayÄ±cÄ±nÄ±zÄ±n ses izinlerini kontrol edin.');
                    });
            } catch (err) {
                console.error('Sound test error:', err);
                showErrorToast('Ses testi baÅŸarÄ±sÄ±z oldu.');
            }
        }
        
        function showSuccessToast(message) {
            const toast = $(`
                <div class="alert alert-success alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="fas fa-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(toast);
            setTimeout(() => toast.fadeOut(() => toast.remove()), 3000);
        }
        
        function showErrorToast(message) {
            const toast = $(`
                <div class="alert alert-danger alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(toast);
            setTimeout(() => toast.fadeOut(() => toast.remove()), 4000);
        }
    </script>
}

